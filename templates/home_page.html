<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>My first WebApp</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-datalabels/2.0.0/chartjs-plugin-datalabels.min.js"
            integrity="sha512-R/QOHLpV1Ggq22vfDAWYOaMd5RopHrJNMxi8/lJu8Oihwi4Ho4BRFeiMiCefn9rasajKjnx9/fTQ/xkWnkDACg=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
<h2>My First Web App</h2>
<p>This is a simple app that shows the effect of transaction costs and rebalancing
    frequency on portfolio performance.</p>
<form action="/" method="post">
    {{input_data.tickers.label}} {{input_data.tickers}}
    <br>
    {{input_data.data_length.label}} {{input_data.data_length}}
    <br>
    {{input_data.initial_wealth.label}} {{input_data.initial_wealth}}
    <br>
    {{input_data.button}}
    <br>
    <hr>
    {% if show_chart %}
    <label>
        Trading cost:
        <input oninput="updateTC(this);amount.value=tc_rangevalue[tc.value]" type="range" id="tc_range" min="0"
               max="49" value="0">
        <output id="amount" name="amount" for="tc_range"> 0</output>
        %
    </label>
    <br>
    <label for="rebalancing_frequency">Rebalancing Frequency:</label>
    <select onchange="updateRF(this)" name="rebalancing_frequency" id="rebalancing_frequency">
        <option selected="selected" value="0">Daily</option>
        <option value="1">Weekly</option>
        <option value="2">Monthly</option>
        <option value="3">Quarterly</option>
        <option value="4">Semi-Annually</option>
        <option value="5">Annually</option>
    </select>
    <canvas id="chart" width="900" height="600"></canvas>
    <script>
    Chart.register(ChartDataLabels);
    const tc_rangevalue = {{tc_rangevalue | safe}}
    const labels = {{labels | safe}}
    const gross = {{gross | safe}}
    const net = {{net | safe}}
    const data = {
        labels: labels,
        datasets:
            [{
            label: "Gross Value",
            data: gross[0],
            borderColor: "blue",
            fill: false,
            borderWidth: 1,
            backgroundColor: "blue",
            pointRadius: 0,
            tension: 0.2
            },
            {
            label: "Net Value",
            data: net[0][0],
            borderColor: "red",
            fill: false,
            borderWidth: 1,
            backgroundColor: "red",
            pointRadius: 0,
            tension: 0.2
            }
        ]}
    var ctx = document.getElementById("chart").getContext("2d");
    const chart = new Chart(ctx, {
        type: "line",
        data: data,
        options: {
            responsive: false,
            layout: {
                padding: {
                    right: 100
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        title: context => {
                            console.log(context);
                            return context[0].label.slice(0,12).replace(/,(\s+)?$/, '');
                        },
                        label: context => {
                            console.log(context);
                            return "$" + context.formattedValue;
                        }
                    }
                },
                datalabels: {
                    formatter: context => {
                        console.log(context);
                        return context.toLocaleString("en-US",{style:"currency", currency:"USD"});
                    },
                    anchor: "right",
                    align: "right",
                    display: function(context) {
                        console.log(context.dataIndex[-1])
                        return (context.dataIndex === context.dataset.data.length-1);
                    }
                },
                title: {
                display: true,
                text: "Portfolio Evolution",
                font: {
                    size: 20
                    }
                },
                legend: {
                    position: "bottom"
                },
            },
            scales: {
                x: {
                    grid: {
                        display: false
                    },
                    type: "time",
                    time: {
                        unit: "day",
                        displayFormats: {
                        day: 'MMM yyyy'
                    }
                    },
                    title : {
                        display: true,
                        text: 'Time',
                        font: {
                            size: 14,
                            weight: 'bold',
                            lineHeight: 1.2,
                            }
                    },
                },
                y: {
                    grid: {
                        display: true
                        },
                    ticks: {
                    callback: function(value, index, ticks) {
                        return value.toLocaleString("en-US",{style:"currency", currency:"USD"});
                        }
                    },
                    title : {
                        display: true,
                        text: 'Market Value',
                        font: {
                            size: 14,
                            weight: "bold",
                            lineHeight: 1.2,
                        }
                    }
                }
            }
        }
    });
    const tc = document.getElementById("tc_range");
    const rb = document.getElementById("rebalancing_frequency");
    function updateTC(range) {
        console.log(range.value);
        const net_data = net[rb.value][tc.value];
        chart.data.datasets[1].data = net_data;
        chart.update();
    }

    function updateRF(rebalancing_frequency) {
        console.log(rebalancing_frequency.value);
        const gross_data = gross[rb.value];
        const net_data = net[rb.value][tc.value];
        chart.data.datasets[0].data = gross_data;
        chart.data.datasets[1].data = net_data;
        chart.update();
    }
    </script>
    {% endif %}
</form>
</body>
</html>